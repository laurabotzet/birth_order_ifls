---
title: "Untitled"
author: "Ruben Arslan"
date: "28 September 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Helper
```{r helper}
source("0_helpers.R")
```


## Data
```{r}
### Import alldata used for birthorder and g-factors computed
alldata_birthorder = readRDS("data/alldata_birthorder.rds")

## For the imputation we want to clean the dataset and get rid of all uninteresting data
alldata_birthorder = alldata_birthorder %>%
  filter(!is.na(pidlink)) %>% # no individuals who are only known from the pregnancy file
  filter(is.na(lifebirths) | lifebirths == 2) %>% # remove 7 and 2 individuals who are known as stillbirth or miscarriage but still have PID
  select(-lifebirths) %>% 
  filter(!is.na(mother_pidlink)) %>% 
  select(-father_pidlink) %>% 
  filter(is.na(any_multiple_birth) | any_multiple_birth != 1) %>% # remove 7 and 2 individuals who are known as stillbirth or miscarriage but still have PID
  select(-starts_with("age_"), -wave, -any_multiple_birth, -multiple_birth) %>% 
  mutate(money_spent_smoking_log = if_else(is.na(money_spent_smoking_log) & ever_smoked == 0, 0, money_spent_smoking_log),
         amount = if_else(is.na(amount) & ever_smoked == 0, 0, amount),
         amount_still_smokers = if_else(is.na(amount_still_smokers) &  still_smoking == 0, 0, amount_still_smokers),
         birthyear = lubridate::year(birthdate))

## For the second imputation we only want to keep nice, non-problematic variables
alldata_birthorder = alldata_birthorder %>%
  select(-birthorder_uterus_alive, -birthorder_uterus_preg,
         -sibling_count_uterus_preg, -sibling_count_naive_ind, -sibling_count_uterus_alive,
         -words_immediate, -words_remembered_avg,
         -Total_score_highest,-Total_score_highest_type, -Math_score_highest, -Math_score_highest_type,
         -birthdate, -birthyear, -marriage_id, 
         -money_spent_smoking_log,-amount_still_smokers, -total_worked, -total_missed, 
         -highest_education, -chron_order_birth, -alive, -death_yr, -death_month
         )
alldata_birthorder = alldata_birthorder %>%
  select(-pidlink)
corr_pipe = . %>%  as.matrix() %>% 
Hmisc::rcorr(.) %>% {
  left_join(left_join(.$r %>% reshape2::melt() %>% rename(r = value), 
                      .$n %>% reshape2::melt() %>% rename(n = value), by = c("Var1", "Var2")),
            .$P %>% reshape2::melt() %>% rename(p = value), 
            by = c("Var1", "Var2"))
  } %>% 
  arrange(desc(r)) %>% 
  filter(Var1 != Var2)

attributes(alldata_birthorder$mother_pidlink)
zap_label <- function(x) {
  UseMethod("zap_label")
}
zap_label.data.frame <- function(x) {
  x[] <- lapply(x, zap_label)
  x
}
zap_label.default <- function(x) {
  attributes(x)$label <- NULL
  x
}
  
alldata_birthorder <- alldata_birthorder %>% haven::zap_labels() %>% haven::zap_formats() %>% zap_label()
str(alldata_birthorder)
alldata_birthorder %>% select_if(function(.)!is.numeric(.)) %>% names()

correlations = corr_pipe(alldata_birthorder %>% select_if(is.numeric))
```

## R Markdown

```{r}
n_imputations.mitml = function(imps) {
  imps$iter$m
}
n_imputations.mids = function(imps) {
  imps$m
}
n_imputations.amelia = function(imps) {
  length(imps$imputations)
}
n_imputations = function(imps) { UseMethod("n_imputations") }

complete.mitml = mitml::mitmlComplete
complete.mids = mice::complete
complete = function(...) { UseMethod("complete") }

library(mice)
library(miceadds)
library(mitml)


sort(round(miss_frac(alldata_birthorder),2))
skimr::skim(alldata_birthorder)
```

test
```{r}
alldata_birthorder$miss_frac_person = rowMeans(is.na(alldata_birthorder))
qplot(alldata_birthorder$miss_frac_person)
alldatasm <-  alldata_birthorder %>% arrange(miss_frac_person) %>% slice(1:1000)
alldata_birthorder$miss_frac_person <- NULL
alldatasm$miss_frac_person <- NULL

predictor_matrix = quickpred(alldatasm, mincor = 0.01)
predictor_matrix[, "mother_pidlink"] = 0
predictor_matrix["mother_pidlink", ] = 0

alldatasm_i = mice(alldatasm, m = 5, maxit = 10, predictorMatrix = predictor_matrix)


plot(alldatasm_i, c("riskB", "raven_2015_young", "birthorder_genes", "English_score_Junior_High", "Sector", "years_of_education", "still_smoking"))

# check densities of imputed/real
densityplot(alldatasm_i, ~ riskB)
densityplot(alldatasm_i, ~ years_of_education)
densityplot(alldatasm_i, ~ birthorder_genes)
densityplot(alldatasm_i, ~ g_factor_2015)

summary(lm(count_backwards ~ raven_2015_young, alldatasm))
summary(lm(count_backwards ~ raven_2015_young, complete(alldatasm_i,1)))
summary(lm(count_backwards ~ raven_2015_old, alldatasm))
summary(lm(count_backwards ~ raven_2015_old, complete(alldatasm_i,1)))
summary(lmer(count_backwards ~ (1 | mother_pidlink), alldatasm))
summary(lmer(count_backwards ~ (1 | mother_pidlink), complete(alldatasm_i,1)))
summary(lmer(riskA ~ (1 | mother_pidlink), alldatasm))
summary(lmer(riskA ~ (1 | mother_pidlink), complete(alldatasm_i,1)))

alldatasm_i <- mids2mitml.list(alldatasm_i)

alldatasm_i <- within(alldatasm_i, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})

alldatasm <- within(alldatasm, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})


qplot(alldatasm_i[[1]]$g_factor_2015)

alldatasm %>% {cor.test(.$g_factor_2015, .$years_of_education)}
alldatasm_i[[1]] %>% {cor.test(.$g_factor_2015, .$years_of_education)}
alldatasm %>% {cor.test(.$g_factor_2015, .$Math_score_Junior_High)}
alldatasm_i[[1]] %>% {cor.test(.$g_factor_2015, .$Math_score_Junior_High)}
```


```{r}
library(future)
plan(multicore(workers = 10))
predictor_matrix = quickpred(alldata_birthorder, mincor = 0.1)
# predictor_matrix[, "mother_pidlink"] = 0
# predictor_matrix["mother_pidlink", ] = 0


imps = listenv::listenv()
for (i in seq_along(1:10)) {
  imps[[i]] %<-% mice(alldata_birthorder, m = 1, maxit = 15, predictorMatrix = predictor_matrix)
}
save(imps, file = "imps.rdata")

all_imps = as.list(imps)
save(all_imps, file = "imps2.rdata")
alldata_birthorder_i = all_imps[[1]]
for (i in seq_along(2:length(all_imps))) {
  alldata_birthorder_i = ibind(alldata_birthorder_i, all_imps[[i]])
}
saveRDS(alldata_birthorder_i, file = "alldata_birthorder_i_ml.rds")

plot(alldata_birthorder_i, c("birthorder_uterus_alive", "birthorder_uterus_preg", "birthorder_genes",
"birthorder_naive"))

plot(alldata_birthorder_i, c("raven_2015_old", "math_2015_old", "count_backwards", "adaptive_numbering"))

plot(alldata_birthorder_i, c("words_immediate", "words_delayed", "words_remembered_avg"))

plot(alldata_birthorder_i, c("big5_ext", "big5_agree", "big5_con", "big5_open", "big5_neu"))



alldatasm_i <- mids2mitml.list(alldatasm_i)

alldatasm_i <- within(alldatasm_i, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})

alldatasm <- within(alldatasm, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})
plot(alldata_birthorder_i, c("birthorder_uterus_alive", "birthorder_uterus_preg", "birthorder_genes",
"birthorder_naive"))
                             

# check densities of imputed/real
densityplot(alldata_birthorder_i, ~ riskB)
densityplot(alldata_birthorder_i, ~ years_of_education)
densityplot(alldata_birthorder_i, ~ birthorder_genes)
densityplot(alldata_birthorder_i, ~ g_factor_2015)

summary(lm(count_backwards ~ raven_2015_young, complete(alldata_birthorder_i,1)))
summary(lm(count_backwards ~ raven_2015_old, alldata_birthorder))
summary(lm(count_backwards ~ raven_2015_old, complete(alldata_birthorder_i,1)))
summary(lmer(count_backwards ~ (1 | mother_pidlink), alldata_birthorder))
summary(lmer(count_backwards ~ (1 | mother_pidlink), complete(alldata_birthorder_i,1)))
summary(lmer(riskA ~ (1 | mother_pidlink), alldata_birthorder))
summary(lmer(riskA ~ (1 | mother_pidlink), complete(alldata_birthorder_i,1)))

alldata_birthorder_i <- mids2mitml.list(alldata_birthorder_i)

alldata_birthorder_i <- within(alldata_birthorder_i, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})

alldata_birthorder <- within(alldata_birthorder, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})


qplot(alldata_birthorder_i[[1]]$g_factor_2015)

alldata_birthorder %>% {cor.test(.$g_factor_2015, .$years_of_education)}
alldata_birthorder %>% {cor.test(.$g_factor_2015, .$Math_score_Junior_High)}
alldata_birthorder_i[[1]] %>% {cor.test(.$g_factor_2015, .$years_of_education)}
alldata_birthorder_i[[1]] %>% {cor.test(.$g_factor_2015, .$Math_score_Junior_High)}


saveRDS(alldata_birthorder_i, file="alldata_birthorder_i.rdata")
```

recompute g_factor
```{r}
within(alldata_birthorder_i, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})
```

analyse beispiel
```{r}
library(lme4)
fit <- with(alldata_birthorder_i, lmer(risk_taking ~ (menstruation_labelled + premenstrual_phase_fab + fertile_fab) * hormonal_contraception + (1 | short), subset = included_d == TRUE))
mitml::testEstimates(fit, var.comp = T)
fit[[1]] # fuer plots
```
