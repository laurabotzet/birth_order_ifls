---
title: "3_imputation_check"
author: "Laura Botzet & Ruben Arslan"
date: "28 September 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

# <span style="color:#B3B3B3">Imputation Checks</span> {.tabset}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Helper
```{r helper}
source("0_helpers.R")
```


## Data
```{r}
### Import alldata used for birthorder and g-factors computed
alldata_birthorder = readRDS("data/alldata_birthorder.rds")

alldata_birthorder_i =  readRDS("data/alldata_birthorder_i_ml.rds")



colnames(alldata_birthorder)

## For the imputation we wanted to clean the dataset and get rid of all uninteresting data
## To get the same dataset that we used for imputation thats what we have to do again:
alldata_birthorder = alldata_birthorder %>%
  filter(!is.na(pidlink)) %>% # no individuals who are only known from the pregnancy file
  filter(is.na(lifebirths) | lifebirths == 2) %>% # remove 7 and 2 individuals who are known as stillbirth or miscarriage but still have PID
  select(-lifebirths) %>% 
  filter(!is.na(mother_pidlink)) %>% 
  select(-father_pidlink) %>% 
  filter(is.na(any_multiple_birth) | any_multiple_birth != 1) %>% # remove 7 and 2 individuals who are known as stillbirth or miscarriage but still have PID
  select(-starts_with("age_"), -wave, -any_multiple_birth, -multiple_birth) %>% 
  mutate(money_spent_smoking_log = if_else(is.na(money_spent_smoking_log) & ever_smoked == 0, 0, money_spent_smoking_log),
         amount = if_else(is.na(amount) & ever_smoked == 0, 0, amount),
         amount_still_smokers = if_else(is.na(amount_still_smokers) &  still_smoking == 0, 0, amount_still_smokers),
         birthyear = lubridate::year(birthdate))
```


## Functions needed

```{r}

n_imputations.mitml = function(imps) {
  imps$iter$m
}
n_imputations.mids = function(imps) {
  imps$m
}
n_imputations.amelia = function(imps) {
  length(imps$imputations)
}
n_imputations = function(imps) { UseMethod("n_imputations") }

complete.mitml = mitml::mitmlComplete
complete.mids = mice::complete
complete = function(...) { UseMethod("complete") }

library(mice)
library(miceadds)
library(mitml)

corr_pipe = . %>%  as.matrix() %>% 
Hmisc::rcorr(.) %>% {
  left_join(left_join(.$r %>% reshape2::melt() %>% rename(r = value), 
                      .$n %>% reshape2::melt() %>% rename(n = value), by = c("Var1", "Var2")),
            .$P %>% reshape2::melt() %>% rename(p = value), 
            by = c("Var1", "Var2"))
  } %>% 
  arrange(desc(r)) %>% 
  filter(Var1 != Var2)

alldata_birthorder_i_g_factor <- mids2mitml.list(alldata_birthorder_i)

alldata_birthorder_i_tbl = alldata_birthorder_i_g_factor %>% tbl_df.mitml.list

```

## Correlations, iterations and density
```{r}
# correlations
correlations_original = corr_pipe(alldata_birthorder %>% select_if(is.numeric))
correlations_imputed = corr_pipe(alldata_birthorder_i_g_factor[[1]] %>% select_if(is.numeric))

correlations_original = correlations_original %>%
  mutate(v = paste0(Var1, Var2)) %>%
  rename(Var1_original = Var1, Var2_original= Var2, n_original = n, r_original = r, p_original = p)

correlations_imputed = correlations_imputed %>%
  mutate(v = paste0(Var1, Var2)) %>%
  rename(Var1_imputed = Var1, Var2_imputed = Var2, n_imputed = n, r_imputed = r, p_imputed = p)

correlations = full_join(correlations_original, correlations_imputed, by = "v")

cor.test(correlations$r_original, correlations$r_imputed)
qplot(correlations$r_original, correlations$r_imputed)


# plot imputation steps
name_columns = colnames(alldata_birthorder_i_tbl[[1]]) %>% as.data.frame 
name_columns = name_columns[name_columns != "mother_pidlink" & name_columns != "age" &
                              name_columns != "any_multiple_birthdate" &
                              name_columns != "sibling_count_naive" &
                              name_columns != "male"]

name_columns_1 = name_columns[1:30]

plot(alldata_birthorder_i, name_columns_1)

pdf("imputation_steps_1.pdf")
plot(alldata_birthorder_i, name_columns_1)
dev.off()


# check densities of imputed/real

densityplot(alldata_birthorder_i, ~ birthorder_genes + sibling_count_genes + birthorder_naive)

densityplot(alldata_birthorder_i, ~ raven_2015_young + math_2015_young + raven_2015_old + math_2015_old)

densityplot(alldata_birthorder_i, ~ words_delayed + adaptive_numbering + count_backwards)
            
densityplot(alldata_birthorder_i, ~ raven_2007_old + raven_2007_young + math_2007_young + math_2007_old)

densityplot(alldata_birthorder_i, ~ big5_ext + big5_con + big5_open + big5_neu + big5_agree)

densityplot(alldata_birthorder_i, ~ riskA + riskB)

densityplot(alldata_birthorder_i, ~ Elementary_missed + Elementary_worked + attended_school + years_of_education + Self_employed)

densityplot(alldata_birthorder_i, ~ ever_smoked + still_smoking + wage_last_month_log + wage_last_year_log)



pdf("density.pdf")
densityplot(alldata_birthorder_i, ~ birthorder_genes + sibling_count_genes + birthorder_naive)

densityplot(alldata_birthorder_i, ~ raven_2015_young + math_2015_young + raven_2015_old + math_2015_old)

densityplot(alldata_birthorder_i, ~ words_delayed + adaptive_numbering + count_backwards)
            
densityplot(alldata_birthorder_i, ~ raven_2007_old + raven_2007_young + math_2007_young + math_2007_old)

densityplot(alldata_birthorder_i, ~ big5_ext + big5_con + big5_open + big5_neu + big5_agree)

densityplot(alldata_birthorder_i, ~ riskA + riskB)

densityplot(alldata_birthorder_i, ~ Elementary_missed + Elementary_worked + attended_school + years_of_education + Self_employed)

densityplot(alldata_birthorder_i, ~ ever_smoked + still_smoking + wage_last_month_log + wage_last_year_log)

dev.off()

# additional analyses based on van Buuren & Groothuis-Oudshoorn, 2011
xyplot(alldata_birthorder_i, birthorder_genes ~ birthorder_naive | .imp , pch = 20, cex = 1.4)

xyplot(alldata_birthorder_i, sibling_count_genes ~ birthorder_genes | .imp , pch = 20, cex = 1.4)

xyplot(alldata_birthorder_i, raven_2015_old ~ birthorder_genes | .imp , pch = 20, cex = 1.4)

```


## G-Factor
```{r g factor}
# Normal data - no misses
no_miss = alldata_birthorder %>%
  filter(!is.na(raven_2015_old), !is.na(math_2015_old), !is.na(count_backwards),
         !is.na(words_delayed), !is.na(adaptive_numbering))
fa.parallel(no_miss %>% select(raven_2015_old, math_2015_old, count_backwards, words_delayed, adaptive_numbering) %>% data.frame())
fa(no_miss %>% select(raven_2015_old, math_2015_old, count_backwards, words_delayed, adaptive_numbering) %>% data.frame(), nfactors = 1)
om_results = omega(no_miss %>% select(raven_2015_old, math_2015_old, count_backwards, words_delayed, adaptive_numbering) %>% data.frame(), nfactors = 1, sl = F)
om_results
omega.diagram(om_results)

"g_factor_nomiss =~ raven_2015_old + math_2015_old + count_backwards +  words_delayed + adaptive_numbering" %>%
  cfa(data = no_miss, std.lv = T, std.ov = T) -> cfa_g
summary(cfa_g)

## Explained variance:
x = inspect(cfa_g, "rsquare")
no_miss$g_factor_nomiss = predict(cfa_g)[,1]

no_miss = no_miss %>% select(pidlink, g_factor_nomiss)

alldata_birthorder = left_join(alldata_birthorder, no_miss, by = "pidlink")
qplot(alldata_birthorder$g_factor_nomiss)

# Imputed data
alldata_birthorder_i_g_factor <- within(alldata_birthorder_i_g_factor, {
  g_factor_2015 <- rowMeans(scale(cbind(raven_2015_old, math_2015_old, count_backwards,  words_delayed, adaptive_numbering)))
})

alldata_birthorder_i_g_factor <- within(alldata_birthorder_i_g_factor, {
  g_factor_2007 <- rowMeans(scale(cbind(raven_2007_old, math_2007_old, count_backwards,  words_delayed, adaptive_numbering)))
})

qplot(alldata_birthorder_i_g_factor[[1]]$g_factor_2015)
qplot(alldata_birthorder_i_g_factor[[1]]$g_factor_2007)

summary(lm(g_factor_nomiss ~ raven_2015_old, alldata_birthorder))
summary(lm(g_factor_2015 ~ raven_2015_old, alldata_birthorder_i_g_factor[[1]]))
summary(lm(g_factor_nomiss ~ raven_2015_young, alldata_birthorder))
summary(lm(g_factor_2015 ~ raven_2015_young, alldata_birthorder_i_g_factor[[1]]))

alldata_birthorder %>% {cor.test(.$g_factor_nomiss, .$years_of_education)}
alldata_birthorder_i_g_factor[[1]] %>% {cor.test(.$g_factor_2015, .$years_of_education)}


saveRDS(alldata_birthorder_i, file="alldata_birthorder_i.rdata")
```
