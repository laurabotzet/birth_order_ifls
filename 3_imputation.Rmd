---
title: "Untitled"
author: "Ruben Arslan"
date: "28 September 2017"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Helper
```{r helper}
source("0_helpers.R")
```


## Data
```{r}
### Import alldata used for birthorder and g-factors computed
alldata_birthorder_full = readRDS("data/alldata_birthorder_full.rds")

colnames(alldata_birthorder_full)
## For the imputation we want to clean the dataset and get rid of all uninteresting data
alldata_birthorder_full = alldata_birthorder_full %>%
  select(starts_with("g_factor"))
```


## R Markdown

```{r}

n_imputations.mitml = function(imps) {
  imps$iter$m
}
n_imputations.mids = function(imps) {
  imps$m
}
n_imputations.amelia = function(imps) {
  length(imps$imputations)
}
n_imputations = function(imps) { UseMethod("n_imputations") }

complete.mitml = mitml::mitmlComplete
complete.amelia = function(imps, action = "long") {
  if (action == "long") {
    dplyr::bind_rows(imps$imputations, .id = "m")
  } else if (is.numeric(action)) {
    imps$imputations[[action]]
  }
}
complete.mids = mice::complete
complete = function(...) { UseMethod("complete") }

library(mice)
library(miceadds)
library(mitml)


miss_frac(alldata_birthorder_full)
codebook::md_pattern(alldata_birthorder_full)
```

```{r}
alldata_birthorder_full_i = mice(alldata_birthorder_full, m = 1)

alldata_birthorder_full_i %>% select(g_factor, g_factor_new, g_factor_crazy, g_factor_nomiss, g_factor_new_nomiss, g_factor_crazy_nomiss, g_factor_2007, g_factor_2015) %>%
  tidyr::gather() %>% 
  ggplot(aes(value)) + geom_histogram() +
  facet_wrap(~ key, scale = "free")

saveRDS(alldata_birthorder_full_i, file="alldata_birthorder_full_i.rdata")


plot(alldata_birthorder_full_i, c("risk_taking", "good_mood"))
# check densities of imputed/real
densityplot(diary_i, ~ risk_taking)
densityplot(diary_i, ~ good_mood)

densityplot(diary_i, ~ lag_risk_taking)
densityplot(diary_i, ~ menstruation_labelled)
densityplot(diary_i, ~ premenstrual_phase_fab)
densityplot(diary_i, ~ fertile_fab)
lm(risk_taking~ lag_risk_taking, diary_lim)
lm(risk_taking~ lag_risk_taking, complete(diary_i,1))
```

analyse beispiel
```{r}
library(lme4)
fit <- with(mids2mitml.list(diary_i), lmer(risk_taking ~ (menstruation_labelled + premenstrual_phase_fab + fertile_fab) * hormonal_contraception + (1 | short), subset = included_d == TRUE))
mitml::testEstimates(fit, var.comp = T)
fit[[1]] # fuer plots
```
