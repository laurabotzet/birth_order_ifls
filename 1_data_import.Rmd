---
output:
  html_document:
    code_folding: "show"
editor_options: 
  chunk_output_type: console
---

#  <span style="color:#FC8D62">Data Wrangling</span> {.tabset}

## Helper
```{r helper}
source("0_helpers.R")
```


## Import data {.active}

All data is retrieved from the [RAND foundation](http://www.rand.org/labor/FLS/IFLS.html) 
```{r Import data}
### Informations about individuals living in the household in 2014/2015
## All Individuals living in the household
bk_ar1 = read_dta("data/hh14_all_dta/bk_ar1.dta") # Book K, Section ar
# compute father pidlink
bk_ar1 = left_join(bk_ar1, bk_ar1 %>% select(hhid14_9, pid14, pidlink) %>% rename(ar10 = pid14, father_pidlink = pidlink), by = c("hhid14_9", "ar10"))
# compute mother pidlink
bk_ar1 = left_join(bk_ar1, bk_ar1 %>% select(hhid14_9, pid14, pidlink) %>% rename(ar11 = pid14, mother_pidlink = pidlink), by = c("hhid14_9", "ar11"))

### Informations from IFLS wave 5 to link data to earlier waves:
ptrack = read_dta("data/hh14_all_dta/ptrack.dta") # Traking informations

### Pregnancy Informations from mother
## Wave 5 - 2014
w5_pregnancy = read_dta("data/hh14_all_dta/b4_ch1.dta") # Book 4, Section ch
## Wave 4 - 2007
w4_pregnancy = read_dta("data/hh07_all_dta/b4_ch1.dta") # Book 4, Section ch
## Wave 3 - 2000
w3_pregnancy = read_dta("data/hh00_all_dta/b4_ch1.dta") # Book 4, Section ch
## Wave 2 - 1997
w2_pregnancy = read_dta("data/hh97dta/b4_ch1.dta") # Book 4, Section ch
## Wave 1 - 1993
w1_pregnancy = read_dta("data/hh93dta/buk4ch1.dta") # Book 4, Section ch

### Marriage information from mother
## Wave 5 - 2014
w5_marriage= read_dta("data/hh14_all_dta/b4_kw3.dta") # Book 4, Section kw3
## Wave 4 - 2007
w4_marriage = read_dta("data/hh07_all_dta/b4_kw2.dta") # Book 4, Section kw2
## Wave 3 - 2000
w3_marriage = read_dta("data/hh00_all_dta/b4_kw3.dta") # Book 4, Section kw3
## Wave 2 - 1997
w2_marriage = read_dta("data/hh97dta/b4_kw2.dta") # Book 4, Section kw2
## Wave 1 - 1993
w1_marriage = read_dta("data/hh93dta/buk4kw2.dta") # Book 4, Section kw2

## Additional marriage information from mother
# Wave 5 - 2014
w5_marriage_additional = read_dta("data/hh14_all_dta/b4_cov.dta") # Book 4, Section cov
# Wave 4 - 2007
w4_marriage_additional = read_dta("data/hh07_all_dta/b4_cov.dta") # Book 4, Section cov
# Wave 3 - 2000
w3_marriage_additional = read_dta("data/hh00_all_dta/b4_cov.dta") # Book 4, Section cov
# Wave 2 - 1997
w2_marriage_additional = read_dta("data/hh97dta/b4_cov.dta") # Book 4, Section cov
# Wave 1 - 1993
w1_marriage_additional = read_dta("data/hh93dta/bukkar2.dta") # Book K, Section ar, household roaster

### IQ Information
ek_ek2 = read_dta("data/hh14_all_dta/ek_ek2.dta") # Book ek2
# additional information (counting backwards, adaptive testing) for adults
b3b_cob = read_dta("data/hh14_all_dta/b3b_cob.dta") # Book 3b, Section cob
b3b_co1 = read_dta("data/hh14_all_dta/b3b_co1.dta") # Book 3b, Section co1
### Personality Information (only for adults)
b3b_psn = read_dta("data/hh14_all_dta/b3b_psn.dta") # Book 3b, Section psn

### Risk taking
b3a_si = read_dta("data/hh14_all_dta/b3a_si.dta") # Book 3a, Section si

### Educational Attainment
b3a_dl1 = read_dta("data/hh14_all_dta/b3a_dl1.dta") # Book 3a, Section dl1

```

## Birth order information {.tabset}
### Information about pregnancy
```{r}
## Select data
w5_pregnancy = w5_pregnancy %>% select(pidlink, ch05, ch06, ch06a, ch08, ch09day, ch09mth, ch09yr, ch25)
w4_pregnancy = w4_pregnancy %>% select(pidlink, ch05, ch06, ch06a, ch08, ch09day, ch09mth, ch09yr, ch25)
w3_pregnancy = w3_pregnancy %>% select(pidlink, ch05, ch06, ch06a, ch08, ch09day, ch09mth, ch09yr, ch25)
w2_pregnancy = w2_pregnancy %>% select(pidlink, ch05, ch06, ch06a, ch08, ch09day, ch09mth, ch09yr, ch25)
w1_pregnancy = w1_pregnancy %>% 
  group_by(pidlink, ch04) %>% mutate(ch06a = if_else(!is.na(pidlink) & !is.na(ch04), if_else( n() > 1, 1, 3), 9)) %>%
  ungroup() %>% 
  select(pidlink, ch05, ch06, ch06a, ch08, ch09day, ch09mth, ch09yr, ch25) %>% 
# In the first wave the year is named wrong
  mutate(ch09yr = ifelse(ch09yr <= 93, ch09yr, NA),
          ch09yr = as.numeric(str_c("19", ch09yr)))

## Combine data
pregnancy = bind_rows(w1 = w1_pregnancy, w2 = w2_pregnancy, w3 = w3_pregnancy, w4 = w4_pregnancy, w5 = w5_pregnancy, .id = "wave")

## Rename Variables
pregnancy = pregnancy %>% rename(chron_order_birth = ch05, lifebirths = ch06, multiple_birth = ch06a, gender = ch08,
                                 birth_day = ch09day, birth_month = ch09mth, birth_year = ch09yr, 
                                 mother_pidlink = pidlink, alive = ch25) # pregnancy$lifebirths values: 1 = still pregnant, 2 = livebirth, 3 = still birth, 4 = misscarriage

## Set values as NA that are missing
pregnancy = pregnancy %>%
  mutate(birth_day = ifelse(birth_day>31, NA, birth_day),
         birth_month = ifelse(birth_month>12, NA, birth_month),
         birth_year = ifelse(birth_year>2016, NA, birth_year),
         birth_day = ifelse(is.nan(birth_day), NA, birth_day),
         birth_month = ifelse(is.nan(birth_month), NA, birth_month),
         birth_year = ifelse(is.nan(birth_year), NA, birth_year),
         multiple_birth = ifelse(multiple_birth == 9, NA, multiple_birth),
         multiple_birth = ifelse(is.nan(multiple_birth), NA, multiple_birth))

pregnancy$month = paste0(pregnancy$birth_year,"-", ifelse(is.na(pregnancy$birth_month), "01",
                                                          pad_month(pregnancy$birth_month)))

pregnancy = pregnancy %>%
  mutate(birthdate = all_available_info_birth_date(birth_year, birth_month, birth_day),
         mother_birthdate = str_c(mother_pidlink, "-", birthdate))


pregnancy = pregnancy %>% 
  mutate(wave_dup = 6 - str_sub(wave, 2, 3) %>% as.numeric()) %>% # from most recent wave to oldest
  arrange(wave_dup) %>% # use most recent wave (because these will have pregnancy outcomes)
  group_by(mother_birthdate) %>% 
  mutate(duped_in_earlier_wave = min_rank(wave_dup)) %>% 
  filter(duped_in_earlier_wave == 1) %>% 
  ungroup() # eliminate dupes across waves (same mother_birthdate), keep mult births

x = (unique(pregnancy$mother_pidlink))

##remove all with missing birthdate/miscarriage date
table(is.na(pregnancy$birthdate))
pregnancy = pregnancy %>%
  filter(!is.na(birthdate))


# for whatever reason there are some multiple births with just one row in the data 
pregnancy %>% group_by(mother_birthdate) %>% mutate(mult = n()) %>% crosstabs(~ mult + multiple_birth, data = .)

## Form variable for any multiple birth in family
pregnancy = pregnancy %>% group_by(mother_pidlink) %>% mutate(any_multiple_birth = if_else(any(multiple_birth == 1), 1, 0))
prop.table(table(pregnancy$multiple_birth))
prop.table(table(pregnancy$any_multiple_birth))
```

### Information about marriage history
```{r marriage history}
## Select marriage data
w5_marriage = w5_marriage %>% select(pidlink, kw10mth, kw10yr, kw18mth, kw18yr, kw11, kw19)
w4_marriage = w4_marriage %>% select(pidlink, kw10mth, kw10yr, kw18mth, kw18yr, kw11, kw19)
w3_marriage = w3_marriage %>% select(pidlink, kw10mth, kw10yr, kw18mth, kw18yr, kw11, kw19)
w2_marriage = w2_marriage %>% select(pidlink, kw10mth, kw10yr, kw18mth, kw18yr, kw11, kw19)
w1_marriage = w1_marriage %>% select(pidlink, kw05a, kw05b, kw13a, kw13b, kw06, kw14age)
# In the first wave the year is named wrong
w1_marriage = w1_marriage %>%
  mutate(kw05a = ifelse(kw05a <= 93, as.numeric(str_c("19", w1_marriage$kw05a)), kw05a),
         kw13a = ifelse(kw13a <=93 , as.numeric(str_c("19", w1_marriage$kw13a)), kw13a))
# And the column names are wrong...
w1_marriage = w1_marriage %>% rename(kw10mth = kw05b, kw10yr = kw05a, kw18mth = kw13b, kw18yr = kw13a, kw11 = kw06, kw19 = kw14age)

## Select additional marriage information (age of respondent)
w5_marriage_additional = w5_marriage_additional %>% select(pidlink, age, dob_yr)
w4_marriage_additional = w4_marriage_additional %>% select(pidlink, age, dob_yr)
w3_marriage_additional = w3_marriage_additional %>% select(pidlink, age, dob_yr)
w2_marriage_additional = w2_marriage_additional %>% select(pidlink, age, dob_yr)
w1_marriage_additional = w1_marriage_additional %>% select(pidlink, ar09yr, ar08yr)
# In the first wave the year is named wrong
w1_marriage_additional = w1_marriage_additional %>%
  mutate(ar08yr = ifelse(ar08yr <= 93, 
                         as.numeric(str_c("19", w1_marriage_additional$ar08yr)),
                         ar08yr))
# And the column names are wrong...
w1_marriage_additional = w1_marriage_additional %>% rename(age = ar09yr, dob_yr = ar08yr)

## Combine marriage information and additional marriage information:
w1_marriage = left_join(w1_marriage, w1_marriage_additional, by = "pidlink") %>%
  mutate(wave = as.numeric("1993"))
w2_marriage = left_join(w2_marriage, w2_marriage_additional, by = "pidlink") %>%
  mutate(wave = as.numeric("1997"))
w3_marriage = left_join(w3_marriage, w3_marriage_additional, by = "pidlink")  %>%
  mutate(wave = as.numeric("2000"))
w4_marriage = left_join(w4_marriage, w4_marriage_additional, by = "pidlink") %>%
  mutate(wave = as.numeric("2007"))
w5_marriage = left_join(w5_marriage, w5_marriage_additional, by = "pidlink") %>%
  mutate(wave = as.numeric("2014"))

## Combine marriage informations
marriage = bind_rows(w1_marriage, w2_marriage, w3_marriage, w4_marriage, w5_marriage)

# Rename columns
marriage = marriage %>% rename(start_year = kw10yr, start_month = kw10mth, end_year = kw18yr, end_month = kw18mth, start_age = kw11, end_age = kw19, birth_year = dob_yr, birth_age = age)


# Set values as NA that are missing
marriage$start_year[ marriage$start_year<1900] = NA
marriage$start_year[ marriage$start_year>2016] = NA
marriage$start_year[ is.nan(marriage$start_year)] = NA
marriage$end_year[ marriage$end_year<1900] = NA
marriage$end_year[ marriage$end_year>2016] = NA
marriage$end_year[ is.nan(marriage$end_year)] = NA
marriage$start_month [marriage$start_month>12] = NA
marriage$start_month [is.nan(marriage$start_month)] = NA
marriage$end_month [marriage$end_month>12] = NA
marriage$end_month [is.nan(marriage$end_month)] = NA
marriage$start_age [marriage$start_age > 97] = NA
marriage$start_age [is.nan(marriage$start_age)] = NA
marriage$end_age [marriage$end_age > 97] = NA
marriage$end_age [is.nan(marriage$end_age)] = NA
marriage$birth_year[ marriage$birth_year<1900] = NA
marriage$birth_year[ marriage$birth_year>2016] = NA
marriage$birth_year[ is.nan(marriage$birth_year)] = NA
marriage$birth_age [marriage$birth_age > 97] = NA
marriage$birth_age [is.nan(marriage$birth_age)] = NA

## Reconstruct marriage start year and end year for marriages with missing year
marriage = marriage %>%
  mutate(birth_year = ifelse(is.na(birth_year), wave - birth_age, birth_year),
         start_year = ifelse(is.na(start_year), birth_year + start_age, start_year),
         end_year = ifelse(is.na(end_year), birth_year + end_age, end_year))


marriage = marriage %>% arrange(pidlink, start_year, start_month, start_age, end_year, end_month, end_age)

marriage = marriage %>% filter(!duplicated(cbind(pidlink, start_year, start_month)) | is.na(start_year) | is.na(start_month)) # nobody gets married twice on the same day, right? so these are dupes.

## Calculate date for beginning of marriage:
marriage = marriage %>% 
  ungroup() %>%
  mutate(start_string = str_c(start_year, "-", ifelse(is.na(start_month), "01",
                                                      pad_month(start_month)), "-01"),
        end_string = str_c(end_year, "-", ifelse(is.na(end_month), "12", pad_month(end_month)), "-01"),
        start = ymd(start_string),
        end = ymd(end_string) + months(1) - days(1))

## Count number of marriages
marriage = marriage %>%
  arrange(pidlink, start, end) %>%
  group_by(pidlink) %>%
  mutate(number_marriages = n(),
         order_marriage = row_number(),
         marriage_id = paste0(pidlink, "_", as.character(order_marriage), "_",
                              as.character(start), "/",as.character(end)))

### Marriage Timeline
minimum_start = min(ymd(str_c(pregnancy$month, "-01")), na.rm = T)
maximum_end = max(ymd(str_c(pregnancy$month, "-01")), na.rm = T)
marriage_timeline = marriage %>%
    mutate(implied_start = as.Date(ifelse(is.na(start), minimum_start , start),
                                   origin="1970-01-01"),
           implied_end = as.Date(ifelse(is.na(end), maximum_end , end),
                                 origin="1970-01-01")) %>%
  filter(implied_start < implied_end)

marriage_timeline = marriage_timeline %>%
    rowwise() %>%
    do(data.frame(
        marriage_id=.$marriage_id, 
        mother_pidlink = .$pidlink,
        order_marriage = .$order_marriage,
        start = .$start,
        end = .$end,
        month = seq(.$implied_start,.$implied_end, by="1 month") ))

# no duplicate mother_id - month combinations (no two marriages at the same time)
marriage_timeline = marriage_timeline %>% 
  arrange(mother_pidlink, start, end) %>% 
  distinct(mother_pidlink, month, .keep_all = TRUE)

marriage_timeline$month = stringr::str_sub(as.character(marriage_timeline$month),1,7)

pregnancy = pregnancy %>% left_join(marriage_timeline, by = c("mother_pidlink", "month")) %>% ungroup()
```


### Birth order calculations {.tabset}
```{r Uterus birthorder and maternal sibling count}
#### Maternal Pregnancy Order
pregnancy1 = pregnancy %>%
  group_by(mother_pidlink) %>%
  mutate(birthorder_uterus_preg = min_rank(birthdate),
         # birthorder_uterus_preg = ifelse(any_multiple_birth == 1, NA, birthorder_uterus_preg),
         sibling_count_uterus_preg = sum(!is.na(birthdate))
         # ,sibling_count_uterus_preg = ifelse(any_multiple_birth == 1, NA, sibling_count_uterus_preg)
         ) %>%
  ungroup()

#### Maternal Birth Order
pregnancy2 = pregnancy %>%
  filter(lifebirths == 2) %>%
  group_by(mother_pidlink) %>%
    mutate(birthorder_uterus_alive = min_rank(birthdate),
           # birthorder_uterus_alive = ifelse(any_multiple_birth == 1, NA, birthorder_uterus_alive),
           sibling_count_uterus_alive = sum(!is.na(birthdate))
           # ,sibling_count_uterus_alive = ifelse(any_multiple_birth == 1, NA, sibling_count_uterus_alive)
           ) %>%
  ungroup()

pregnancy2 = pregnancy2 %>% select(mother_birthdate, birthorder_uterus_alive, sibling_count_uterus_alive) %>% distinct()

#### Parental Full Sibling Birthorder
pregnancy3 = pregnancy %>%
  filter(lifebirths == 2) %>%
  group_by(marriage_id) %>%
    mutate(birthorder_genes = min_rank(birthdate),
           birthorder_genes = ifelse(is.na(marriage_id), NA, birthorder_genes),
           sibling_count_genes = ifelse(is.na(marriage_id), NA, sum(!is.na(marriage_id)))) %>%
  ungroup()

pregnancy3 = pregnancy3 %>% select(mother_birthdate, birthorder_genes, sibling_count_genes) %>% distinct()


### Combine birthorder data
pregnancy = left_join(pregnancy1, pregnancy2, by="mother_birthdate") %>% ungroup()
pregnancy = left_join(pregnancy, pregnancy3, by = "mother_birthdate") %>% ungroup()
```


### Birth order graphs
```{r}
### Graphs
## Biological Birthorder - Uterus_Pregnancies
ggplot(pregnancy, aes(x=sibling_count_uterus_preg, y=birthorder_uterus_preg)) + geom_jitter(alpha = 0.1)

## Biological Birthorder - Uterus_Births
ggplot(pregnancy, aes(x=sibling_count_uterus_alive, y=birthorder_uterus_alive)) + geom_jitter(alpha = 0.1)

## Biological Birthorder - Full Sibling Order
ggplot(pregnancy, aes(x=sibling_count_genes, y=birthorder_genes)) + geom_jitter(alpha = 0.1)

## Bio: Uterus_preg vs. Uterus_Births
ggplot(pregnancy, aes(x=birthorder_uterus_preg, y=birthorder_uterus_alive)) + geom_jitter(alpha = 0.1)
# The birth_order_alive is always lower, which makes sense, becaus not live births (miscarriage, still births are excluded)

## Bio: Uterus_preg vs. Genes
ggplot(pregnancy, aes(x=birthorder_uterus_preg, y=birthorder_genes)) + geom_jitter(alpha = 0.1)
# The birth_order_alive is always lower, which makes sense, becaus not live births (miscarriage, still births are excluded)

## Bio: Uterus_alive vs. Genes
ggplot(pregnancy, aes(x=birthorder_uterus_alive, y=birthorder_genes))  + geom_jitter(alpha = 0.1)
# The birth_order_alive is always lower, which makes sense, becaus not live births (miscarriage, still births are excluded)

pregnancy %>% select(birthorder_uterus_alive, birthorder_uterus_preg, birthorder_genes) %>% na.omit() %>% cor()
pregnancy %>% select(birthorder_uterus_alive, birthorder_uterus_preg, birthorder_genes) %>% missingness_patterns()
pregnancy %>% select(sibling_count_uterus_alive, sibling_count_uterus_preg, sibling_count_genes) %>% missingness_patterns()
```

## Select individual data from IFLS 5
```{r select individual data}
### Individuals
individuals = bk_ar1 %>% select(hhid14_9, pidlink, father_pidlink, mother_pidlink, ar01a, ar02b, ar10, ar11, ar07, ar08day, ar08mth, ar08yr, ar09, ar18eyr, ar18emth)
#Rename variables to make it easier
individuals = rename(individuals, relation_to_HH_head = ar02b, fatherID = ar10, motherID = ar11, sex = ar07, age = ar09, status = ar01a, death_yr = ar18eyr, death_month = ar18emth) 
# Remove duplicats (some people are mentioned in two households, e.g. because they moved in the last 12 months)
individuals = individuals %>% distinct(pidlink, .keep_all = TRUE)
individuals_unchanged = individuals

## people whose parents can not be identified have to be marked as NA:
individuals$fatherID[ individuals$fatherID>50] = NA
individuals$motherID[ individuals$motherID>50] = NA


## Create date of birth
#Set all variables missing that have not been reported:
individuals$ar08day[ individuals$ar08day>31] = NA
individuals$ar08mth[ individuals$ar08mth>12] = NA
individuals$ar08yr[ individuals$ar08yr>2016] = NA
individuals$ar08day[ is.nan(individuals$ar08day) ] = NA
individuals$ar08mth[ is.nan(individuals$ar08mth) ] = NA
individuals$ar08yr[ is.nan(individuals$ar08yr)] = NA
individuals$death_month[ individuals$death_month>12] = NA
individuals$death_yr[ individuals$death_yr>2016] = NA
individuals$death_month[ is.nan(individuals$death_month) ] = NA
individuals$death_yr[ is.nan(individuals$death_yr)] = NA

## Create variable that contains pidlink of mother and birthdate of child:
individuals = individuals %>%
    mutate(birthdate = all_available_info_birth_date(ar08yr, ar08mth, ar08day),
           mother_birthdate = str_c(mother_pidlink, "-", birthdate)) # mother_pidlink-YYYY-MM; is NA if birth_year is missing

##Remove all with missing mother_birthdate
individuals = individuals %>%
  filter(!is.na(mother_birthdate))


## Combine information from pregnancy history and individual files
pregnancy = pregnancy %>%
  group_by(mother_birthdate) %>%
  mutate(twin_order = row_number(birthdate),
         mother_birthdate_unique = paste0(mother_birthdate, "-", twin_order)) %>%
  ungroup()

individuals = individuals %>%
  group_by(mother_birthdate) %>%
  mutate(twin_order = row_number(birthdate),
         mother_birthdate_unique = paste0(mother_birthdate, "-", twin_order)) %>%
  ungroup() %>%
  select(mother_birthdate_unique, pidlink, sex, age)


pregnancy_missing = pregnancy %>%
  mutate(missing = ifelse(!(mother_birthdate_unique %in% individuals$mother_birthdate_unique),
                          1, 0)) %>%
  filter(missing == 1)

# prevent that twins exist 4 times because they appear twice in pregnancy and twice in individuals, by eliminating dupes from pregnancy
pregnancy_not_missing = pregnancy %>%
  mutate(missing = ifelse(!(mother_birthdate_unique %in% individuals$mother_birthdate_unique),
                          1, 0)) %>%
  filter(missing == 0)          

alldata_pregnancy = left_join(pregnancy_not_missing, individuals,
                              by = "mother_birthdate_unique")

alldata_pregnancy = bind_rows(alldata_pregnancy, pregnancy_missing)

prop.table(table(alldata_pregnancy$multiple_birth))
prop.table(table(alldata_pregnancy$any_multiple_birth))
```


## Intelligence {.tabset}
```{r select IQ data}
### IQ Informations
##ek2 (>14yrs)
iq2.1 = ek_ek2 %>% select(hhid14_9, pidlink, age, sex, ektype, resptype, result, reason, ek1_ans, ek2_ans, ek3_ans, ek4_ans, ek5_ans, ek6_ans, ek7_ans, ek8_ans, ek9_ans, ek10_ans, ek11_ans, ek12_ans, ek13_ans, ek14_ans, ek15_ans, ek16_ans, ek17_ans, ek18_ans, ek19_ans, ek20_ans, ek21_ans, ek22_ans)


##additional informations for adults: counting backwards
iq2.2 = b3b_co1 %>% select(hhid14_9, pidlink, co04a, co04b, co04c, co04d, co04e, co07count, co10count)
##additional informations for adults: adaptive number test
iq2.3 = b3b_cob %>% select(hhid14_9, pidlink, w_abil, cob18, cob19b)

## put all the informations for participants >= 15 together
iq2 = full_join(iq2.1, iq2.2, by = "pidlink")
iq2 = full_join(iq2, iq2.3, by = "pidlink")
iq = iq2
iq <- plyr::rename(iq, c("age"="IQage")) 

### calculate iq scores
##Raven Test
answered_raven_items = iq %>% select(ek1_ans:ek6_ans, ek11_ans, ek12_ans)
psych::alpha(data.frame(answered_raven_items))
iq$raven = rowMeans( answered_raven_items, na.rm = T)
iq$raven[! iq$result %in% 1:2] = NA
qplot(iq$raven)

##Math Test
answered_math_items = iq %>% select(ek18_ans:ek22_ans)
psych::alpha(data.frame(answered_math_items))
iq$math = rowMeans( answered_math_items, na.rm = T)
iq$math[! iq$result %in% 1:2] = NA
qplot(iq$math)

##Counting Items
# Create Right/Wrong Scores for the counting items
iq$co04aright = as.numeric(iq$co04a == 93)
iq$co04bright = as.numeric(iq$co04b == iq$co04a-7)
iq$co04cright = as.numeric(iq$co04c == iq$co04b-7)
iq$co04dright = as.numeric(iq$co04d == iq$co04c-7)
iq$co04eright = as.numeric(iq$co04e == iq$co04d-7)

answered_counting_items = iq %>% select(co04aright:co04eright)
psych::alpha(data.frame(answered_counting_items))
iq$count_backwards = rowSums( answered_counting_items, na.rm = T) / 5
qplot(iq$count_backwards)

## Word Memory
iq$words_immediate = iq$co07count
iq$words_delayed = iq$co10count
qplot(iq$words_immediate, iq$words_delayed, geom = "jitter")
answered_word_items = iq %>% select(co07count,co10count)
psych::alpha(data.frame(answered_word_items))
iq$words_remembered_avg = rowMeans( answered_word_items, na.rm = T)
qplot(iq$words_remembered_avg)

##Adaptive Numbering
iq$adaptive_numbering = iq$w_abil
qplot(iq$adaptive_numbering)

## Correlation of all Iq-Tests
round(cor(iq %>% select(raven, math, count_backwards, words_immediate, words_delayed, adaptive_numbering), use = "pairwise.complete.obs"), 2)

##Missingness_Patterns
formr::missingness_patterns(iq %>% select(raven, math, count_backwards, words_immediate, words_delayed, adaptive_numbering))

##g_factor
"g_factor =~ raven + math + count_backwards +  words_delayed+ adaptive_numbering" %>%
  cfa(missing = "fiml", data = iq, std.lv = T, std.ov = T) -> cfa_g
summary(cfa_g)

iq$g_factor = predict(cfa_g)[,1]
iq = iq %>%
  mutate(g_factor = ifelse(is.na(raven), NA, g_factor),
         g_factor = ifelse(is.na(math), NA, g_factor),
         g_factor = ifelse(is.na(count_backwards), NA, g_factor),
         g_factor = ifelse(is.na(words_immediate), NA, g_factor),
         g_factor = ifelse(is.na(words_delayed), NA, g_factor),
         g_factor = ifelse(is.na(adaptive_numbering), NA, g_factor))
qplot(iq$g_factor)
```



## Personality
```{r select pesonality data}
### Personality
##Rearrange personality data so that every individual has only one row
pers = spread(b3b_psn, psntype, psn01)
##name columns
colnames(pers) <- c("hhid14_9", "pid14", "hhid14", "pidlink", "version", "module", "e1", "c1", "o1", "e2r", "n1r", "a1", "n2r", "o2", "c2r", "o3", "a2", "c3", "e3", "a3r", "n3")
pers = pers %>% select(hhid14_9, pidlink, e1, c1, o1, e2r, n1r, a1, n2r, o2, c2r, o3, a2, c3, e3, a3r, n3)

##Extraversion
pers$e2r_reversed = 6 - pers$e2r
extraversion = pers %>% select(e1, e2r_reversed, e3)
psych::alpha(data.frame(extraversion), check.keys = T)
pers$big5_ext = rowMeans(extraversion)
qplot(pers$big5_ext)

##conscientiousness
pers$c2r_reversed = 6 - pers$c2r
conscientiousness = pers %>% select(c1, c2r_reversed, c3)
psych::alpha(data.frame(conscientiousness), check.keys = T)
pers$big5_con = rowMeans(conscientiousness)
qplot(pers$big5_con)

##Openness
openness = pers %>% select(o1, o2, o3)
psych::alpha(data.frame(openness), check.keys = T)
pers$big5_open = rowMeans(openness)
qplot(pers$big5_open)

## Neuroticism
pers$n1r_reversed = 6 - pers$n1r
pers$n2r_reversed = 6 - pers$n2r
neuroticism = pers %>% select(n1r_reversed, n2r_reversed, n3)
pers$big5_neu = rowMeans(neuroticism)
qplot(pers$big5_neu)

##Agreeableness
pers$a3r_reversed = 6- pers$a3r
agreeableness= pers %>% select(a1, a2, a3r_reversed)
pers$big5_agree = rowMeans(agreeableness)
qplot(pers$big5_agree)
```


## Risk preference
```{r select risk taking data}
###Risktaking
risk = b3a_si %>% select(hhid14_9, pidlink, random_si, si01, si02, si03, si04, si05, si11, si12, si13, si14, si15)

## 8 means they didnt know which answer they would choose
risk$si01[ risk$si01 == 8] = NA
risk$si02[ risk$si02 == 8] = NA
risk$si03[ risk$si03 == 8] = NA
risk$si04[ risk$si04 == 8] = NA
risk$si05[ risk$si05 == 8] = NA
risk$si11[ risk$si11 == 8] = NA
risk$si12[ risk$si12 == 8] = NA
risk$si13[ risk$si13 == 8] = NA
risk$si14[ risk$si14 == 8] = NA
risk$si15[ risk$si15 == 8] = NA

## calculate a risk score for risk game A 
# (5 = gamble averse, Ordinalskala : 1 = risk loving, 4 = risk averse)
risk$riskA = ifelse(risk$si01 == 1 & risk$si02 == 1, 5,
             ifelse(risk$si01 == 2 & risk$si03 == 1 & risk$si04 == 1, 4,
             ifelse(risk$si01 == 2 & risk$si03 == 1 & risk$si04 == 2, 3,
             ifelse(risk$si01 == 2 & risk$si03 == 2 & risk$si05 == 1, 2,
             ifelse(risk$si01 == 2 & risk$si03 == 2 & risk$si05 == 2, 1,
             NA)))))
qplot(risk$riskA[risk$riskA != 5])

## calculate a risk score for risk game B 
# (5 = gamble averse, Ordinalskala : 1 = risk loving, 4 = risk averse)
risk$riskB = ifelse(risk$si11 == 2 & risk$si12 == 1, 5,
             ifelse(risk$si11 == 1 & risk$si13 == 1 & risk$si14 == 1, 4,
             ifelse(risk$si11 == 1 & risk$si13 == 1 & risk$si14 == 2, 3,
             ifelse(risk$si11 == 1 & risk$si13 == 2 & risk$si15 == 1, 2,
             ifelse(risk$si11 == 1 & risk$si13 == 2 & risk$si15 == 2, 1,
             NA)))))
qplot(risk$riskB[risk$riskB !=5])

psych::alpha(data.frame(risk %>% select(riskA, riskB)), check.keys = T)


```

## Educational Attainment
```{r select educational attainment data}
# Select, rename and mutate data
ea = b3a_dl1 %>%
  select(pidlink, dl04, dl06, dl07, dl07a, dl07aa) %>%
  rename(pidlink = pidlink, attended_school = dl04, highest_education = dl06,
         highest_grade=dl07, currently_attending_school = dl07a, hours_in_class = dl07aa) %>%
  mutate(attended_school = as.factor(ifelse(attended_school == 8, NA,
                                            ifelse(attended_school == 1, "yes",
                                                   ifelse(attended_school == 3, "no",
                                                          attended_school)))),
         highest_education = as.factor(ifelse(highest_education == 2 | highest_education == 72,
                                                     "Elementary",
                                                     ifelse(highest_education == 3 |
                                                              highest_education == 4 |
                                                              highest_education == 73,
                                                            "Junior High",
                                                            ifelse(highest_education == 5 |
                                                                     highest_education == 6 |
                                                                     highest_education == 74,
                                                                   "Senior High",
                                                                   ifelse(highest_education == 60 |
                                                                            highest_education == 61 |
                                                                            highest_education == 62 |
                                                                            highest_education == 63 |
                                                                            highest_education == 13,
                                                                          "University", NA))))),#"other" = NA
         highest_grade = ifelse(highest_grade == 98, NA,
                                ifelse(highest_grade == 99, NA, highest_grade)),
         currently_attending_school = as.factor(ifelse(currently_attending_school == 1, "yes",
                                                       ifelse(currently_attending_school == 3, "no", NA))),
         hours_in_class = ifelse(hours_in_class == 99, NA,
                                 ifelse(hours_in_class == 98, NA, hours_in_class)))

## Create variable that includes years of education (highest_education.highest_grade) as a numeric variable
ea = ea %>%
  mutate(years_of_education_factor = as.factor(str_c(highest_education, ".", highest_grade)),
         years_of_education = as.numeric(ifelse(attended_school == "no", 0,
                                         ifelse(years_of_education_factor == "Elementary.0", 0.5,
                                         ifelse(years_of_education_factor == "Elementary.1", 1,
                                         ifelse(years_of_education_factor == "Elementary.2", 2,
                                         ifelse(years_of_education_factor == "Elementary.3", 3,
                                         ifelse(years_of_education_factor == "Elementary.4", 4,
                                         ifelse(years_of_education_factor == "Elementary.5", 5,
                                         ifelse(years_of_education_factor == "Elementary.6", NA,
                                         ifelse(years_of_education_factor == "Elementary.7", 6,
                                         ifelse(years_of_education_factor == "Junior High.0", 6.5,
                                         ifelse(years_of_education_factor == "Junior High.1", 7,
                                         ifelse(years_of_education_factor == "Junior High.2", 8,
                                         ifelse(years_of_education_factor == "Junior High.3", NA,
                                         ifelse(years_of_education_factor == "Junior High.7", 9,
                                         ifelse(years_of_education_factor == "Senior High.0", 9.5,
                                         ifelse(years_of_education_factor == "Senior High.1", 10,
                                         ifelse(years_of_education_factor == "Senior High.2", 11,
                                         ifelse(years_of_education_factor == "Senior High.3", NA,
                                         ifelse(years_of_education_factor == "Senior High.7", 12,
                                         ifelse(years_of_education_factor == "University.0", 12.5,
                                         ifelse(years_of_education_factor == "University.1", 13,
                                         ifelse(years_of_education_factor == "University.2", 14,
                                         ifelse(years_of_education_factor == "University.3", 15,
                                         ifelse(years_of_education_factor == "University.4", 16,
                                         ifelse(years_of_education_factor == "University.5", 17,
                                         ifelse(years_of_education_factor == "University.6", NA,
                                         ifelse(years_of_education_factor == "University.7", 18,
                                                NA)))))))))))))))))))))))))))))
qplot(ea$years_of_education)
```


## Merge data

```{r merge data}
### Merge all data for people with birthorder informations
alldata_birthorder = left_join(alldata_pregnancy, iq, by = "pidlink")
alldata_birthorder = left_join(alldata_birthorder, pers, by = "pidlink")
alldata_birthorder = left_join(alldata_birthorder, risk, by = "pidlink")
alldata_birthorder = left_join(alldata_birthorder, ea, by = "pidlink")

alldata = left_join(individuals_unchanged, iq, by = "pidlink")
alldata = left_join(alldata, pers, by = "pidlink")
alldata = left_join(alldata, risk, by = "pidlink")
alldata = left_join(alldata, ea, by = "pidlink")


### Which values are missing?
## All data
formr::missingness_patterns(alldata_birthorder %>% select(raven, math, count_backwards, words_immediate, words_delayed, adaptive_numbering, big5_ext, riskA, riskB))
## Intelligence
formr::missingness_patterns(alldata_birthorder %>% select(raven, math, count_backwards, words_immediate, words_delayed, adaptive_numbering))
##Personality
formr::missingness_patterns(alldata_birthorder %>% select(big5_ext, big5_con, big5_open, big5_neu, big5_agree))
##Risk
formr::missingness_patterns(alldata_birthorder %>% select(riskA, riskB))
```

## Save data

for future analyses

```{r save data}
alldata_birthorder = alldata_birthorder %>% ungroup()
alldata = alldata %>% ungroup()
pregnancy = pregnancy %>% ungroup()

saveRDS(alldata_birthorder, file = "data/alldata_birthorder.rds")
saveRDS(alldata, file = "data/alldata.rds")
saveRDS(pregnancy, file = "data/pregnancy.rds")
```
